// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" 
}

model KnowledgeBase {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  name             String
  description      String?  @db.Text
  vectorDb         String   @map("vector_db")
  connectionConfig Json     @map("connection_config")
  chunkSize        Int      @default(512) @map("chunk_size")
  chunkOverlap     Int      @default(50) @map("chunk_overlap")
  embeddingModel   String   @map("embedding_model")
  useOcr           Boolean  @default(false) @map("use_ocr")
  status           String   @default("Draft") // 'Draft', 'Processing', 'Ready', 'Error'
  documentCount    Int      @default(0) @map("document_count")
  chunkCount       Int      @default(0) @map("chunk_count")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@index([userId])
  @@map("knowledge_bases")
}

model ChatSession {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  title       String
  framework   String
  agentId     String?   @map("agent_id")
  agentConfig Json      @map("agent_config")
  memoryUsage Float     @default(0.0) @map("memory_usage")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  isActive    Boolean   @default(true) @map("is_active")

  messages Message[]
  metrics  ChatMetric[]
  agent    Agent?       @relation(fields: [agentId], references: [agentId], onDelete: SetNull)

  @@index([userId])
  @@index([agentId])
  @@map("chat_sessions")
}

model Message {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  sender    String
  text      String
  timestamp DateTime @default(now()) @db.Timestamptz
  files     Json?

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("messages")
}

model LLMProvider {
  id                  String   @id @default(uuid())
  name                String   @unique
  displayName         String   @map("display_name")
  baseUrl             String   @map("base_url")
  logoUrl             String?  @map("logo_url")
  description         String?  @db.Text
  requiresApiKey      Boolean  @default(true) @map("requires_api_key")
  supportsStreaming   Boolean  @default(true) @map("supports_streaming")
  supportsTools       Boolean  @default(true) @map("supports_tools")
  supportsEmbeddings  Boolean  @default(false) @map("supports_embeddings")
  maxTokens           Int      @default(4096) @map("max_tokens")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz

  models LLMModel[]

  @@index([name])
  @@map("llm_providers")
}

model LLMModel {
  id            String   @id @default(uuid())
  providerId    String   @map("provider_id")
  modelId       String   @map("model_id")
  displayName   String   @map("display_name")
  description   String?  @db.Text
  contextLength Int      @default(4096) @map("context_length")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  provider LLMProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([modelId])
  @@map("llm_models")
}

model ChatMetric {
  id               String   @id @default(uuid())
  sessionId        String   @map("session_id")
  userId           String   @map("user_id")
  providerId       String   @map("provider_id")
  modelId          String   @map("model_id")
  inputTokens      Int?     @map("input_tokens")
  outputTokens     Int?     @map("output_tokens")
  totalTokens      Int?     @map("total_tokens")
  completionTime   Float?   @map("completion_time")
  promptTime       Float?   @map("prompt_time")
  queueTime        Float?   @map("queue_time")
  totalTime        Float?   @map("total_time")
  modelName        String?  @map("model_name")
  systemFingerprint String? @map("system_fingerprint")
  serviceTier      String?  @map("service_tier")
  finishReason     String?  @map("finish_reason")
  responseMetadata Json?    @map("response_metadata")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@map("chat_metrics")
}

model Agent {
  agentId      String   @id @default(uuid()) @map("AgentId")
  userId       String   @map("user_id")
  name         String
  description  String?  @db.Text
  architecture String   // 'mono' or 'multi'
  framework    String   // 'langchain', 'crewai', etc.
  settings     Json
  tools        Json?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  sessions  ChatSession[]
  sandboxes Sandbox[]

  @@index([userId])
  @@map("agents")
}

model UserSecret {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  secretValue String   @map("secret_value")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@index([userId])
  @@map("user_secrets")
}

model Sandbox {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  agentId        String?  @map("agent_id")
  e2bSandboxId   String   @unique @map("e2b_sandbox_id")
  templateId     String   @map("template_id")
  state          String   @default("running") // 'running', 'paused', 'killed'
  metaInfo       Json?    @map("meta_info")
  timeoutSeconds Int      @map("timeout_seconds")
  startedAt      DateTime @map("started_at") @db.Timestamptz
  expiresAt      DateTime @map("expires_at") @db.Timestamptz
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  agent   Agent?          @relation(fields: [agentId], references: [agentId], onDelete: SetNull)
  metrics SandboxMetric[]
  events  SandboxEvent[]

  @@index([userId])
  @@index([agentId])
  @@index([e2bSandboxId])
  @@index([state])
  @@map("sandboxes")
}

model SandboxMetric {
  id             String   @id @default(uuid())
  sandboxId      String   @map("sandbox_id")
  timestamp      DateTime @db.Timestamptz
  cpuUsedPct     Float    @map("cpu_used_pct")
  memUsedBytes   BigInt   @map("mem_used_bytes")
  memTotalBytes  BigInt   @map("mem_total_bytes")
  diskUsedBytes  BigInt   @map("disk_used_bytes")
  diskTotalBytes BigInt   @map("disk_total_bytes")

  sandbox Sandbox @relation(fields: [sandboxId], references: [id], onDelete: Cascade)

  @@index([sandboxId])
  @@index([timestamp])
  @@map("sandbox_metrics")
}

model SandboxEvent {
  id        String   @id @default(uuid())
  sandboxId String   @map("sandbox_id")
  timestamp DateTime @db.Timestamptz
  eventType String   @map("event_type") // 'sandbox.lifecycle.created', 'sandbox.lifecycle.killed', etc.
  eventData Json?    @map("event_data")

  sandbox Sandbox @relation(fields: [sandboxId], references: [id], onDelete: Cascade)

  @@index([sandboxId])
  @@index([timestamp])
  @@map("sandbox_events")
}